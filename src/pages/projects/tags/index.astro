---
import type { CollectionEntry } from 'astro:content'
import { getCollection } from 'astro:content'
import { Button } from 'astro-pure/user'
import PageLayout from '@/layouts/BaseLayout.astro'

function normalizeTags(v: unknown): string[] {
  if (Array.isArray(v)) return v.map(String).map(s => s.trim()).filter(Boolean)
  if (typeof v === 'string') return v.split(',').map(s => s.trim()).filter(Boolean)
  return []
}

export const prerender = true

const all = (await getCollection('projects', ({ data }) =>
  import.meta.env.DEV ? true : !data.draft
)).sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime())

// 태그별 카운트
const map = new Map<string, number>()
for (const p of all) {
  for (const t of normalizeTags((p.data as any).tags)) {
    map.set(t, (map.get(t) ?? 0) + 1)
  }
}
const tags = Array.from(map.entries()).sort((a, b) => a[0].localeCompare(b[0]))

const meta = { title: 'Project Tags', description: 'Browse projects by tags' }
---

<PageLayout {meta}>
  <main class="mt-6 lg:mt-10">
    <div id="content-header" class="animate">
      <h1 class="mb-6 text-3xl font-medium">Project Tags</h1>
    </div>

    {tags.length === 0 ? (
      <p>No tags yet.</p>
    ) : (
      <ul class="flex flex-wrap gap-2">
        {tags.map(([tag, count]) => (
          <li>
            <Button href={`/projects/tags/${encodeURIComponent(tag)}`} variant="pill">
              {tag} ({count})
            </Button>
          </li>
        ))}
      </ul>
    )}
  </main>
</PageLayout>
